#!/bin/bash
set -euxo pipefail

#-------
# Parcel fabric
#-------

PSQL="psql $DATABASE_URL -v ON_ERROR_STOP=1"

# rename downloaded file so ogr can read without unzipping
wget --trust-server-names -qN \
   -O /tmp/pmbc_parcel_fabric_poly_svw.gdb.zip \
   https://pub.data.gov.bc.ca/datasets/4cf233c2-f020-4f7a-9b87-1923252fbc24/pmbc_parcel_fabric_poly_svw.zip

ogr2ogr \
   --config PG_USE_COPY YES \
   -t_srs EPSG:3005 \
   -dim XY \
   -f PostgreSQL \
   PG:$DATABASE_URL \
   -lco GEOMETRY_NAME=geom \
   -lco FID=PARCEL_FABRIC_POLY_ID \
   -nln bcdata.pmbc_parcel_fabric_poly_svw \
   /tmp/pmbc_parcel_fabric_poly_svw.gdb.zip \
   pmbc_parcel_fabric_poly_svw

# load to target & drop temp
$PSQL -c "truncate whse_cadastre.pmbc_parcel_fabric_poly_svw"
$PSQL -c "insert into whse_cadastre.pmbc_parcel_fabric_poly_svw select * from bcdata.pmbc_parcel_fabric_poly_svw"
$PSQL -c "drop table bcdata.pmbc_parcel_fabric_poly_svw"
